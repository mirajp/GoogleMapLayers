<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Some Title</title>
		<script type="text/javascript"  src="http://maps.google.com/maps/api/js?"></script>
		<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/src/markerclusterer.js"></script>
		<script type="text/javascript" src="./lib/alasql.min.js"></script>
		<style>
			html, body, #map {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	
	<body onload='initMarkers()'>
		<script>
			var map, mc;
			var mcOptions = {gridSize: 20, maxZoom: 17};
			var headers;
			var markerData = {};
			var gmarkers = [];
			var infowindow = new google.maps.InfoWindow({
				maxWidth: 330
			});
			
			function initMarkers() {
				console.log("Creating the markers...");
				var csvUrl = 'http://localhost:8000/data/pscdata.csv';
				alasql('SELECT * FROM CSV("'+csvUrl+'",{headers:true})', [], function(data){
					//console.log(data);
					console.log("Data shows " + data.length + " outage reports.");
					// Headers of the csv:
					headers = ['ID','Address','Latitude','Longitude','Date Time From','Date Time To','Fault Location',
									'Partial','Root Cause','Sub Cause','Ticket No','Weather','Customer Hrs','Duration','No Cust Interrupts'];
					for (var i = 0; i < data.length; i++) {
						if (data[i]['Latitude'] != "NOT FOUND") {
							var dataAddress = data[i]['Address'];
							// If the address is already in the markerData map, then append on values
							if (dataAddress in markerData) {
								var numEntries = markerData[dataAddress]['Num Entries'];
								for (var j = 0; j < headers.length; j++) {
									var headerName = headers[j];
									if (headerName != 'Address' && headerName != 'Latitude' && headerName != 'Longitude' && headerName != 'ID') {
										var strLength = Number(('' + markerData[dataAddress][headerName] + '').length + headerName.length);
										var numExtra = parseFloat(numEntries)-1;
										var extraLength = Number(numExtra*32);
										var expectedLength = extraLength + 45;
										var padAmount = expectedLength - strLength;
										for (var p = 0; p < padAmount; p++) {
											markerData[dataAddress][headerName] += ",";
										}
									}
								}
								numEntries++;
								markerData[dataAddress]['Num Entries'] = numEntries;
								
								for (var j = 0; j < headers.length; j++) {
									var headerName = headers[j];
									if (headerName != 'Address' && headerName != 'Latitude' && headerName != 'Longitude' && headerName != 'ID') {
										markerData[dataAddress][headerName] += '' + data[i][headerName];
									}
								}
							}
							else {
								markerData[dataAddress] = {};
								for (var j = 0; j < headers.length; j++) {
									var headerName = headers[j];
									markerData[dataAddress][headerName] = data[i][headerName];
									/*
									if (dataAddress == '249 E 123 ST') {
										console.log(headerName + ": " + data[i][headerName]);
									}
									*/
								}
								markerData[dataAddress]['Num Entries'] = 1;
							}
						}
					}
					initialize();
				});
			}
			
			function createMarker(index) {
				var latlng = new google.maps.LatLng(parseFloat(markerData[index]['Latitude']),parseFloat(markerData[index]['Longitude']));
				var number;
				if (markerData[index]["Num Entries"] >= 9) {
					number = 9;
				}
				else {
					number = markerData[index]["Num Entries"];
				}
				var marker = new google.maps.Marker({
					position: latlng,
					map: map,
					icon: "http://localhost:8000/markers/" + number + ".png",
					title: markerData[index]['Address']
				});
				
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.close();
					
					var text = "<font face='courier'><b>" + markerData[index]['Address'] + " - (" +  markerData[index]['Num Entries'] + ")</b><pre>";
					for (var headerIter = 4; headerIter < headers.length; headerIter++) {
						var headerName = headers[headerIter];
						text +=  "<b>" + headerName + "</b>: " + ('' + markerData[index][headerName] + '').replace(/,/g, '&nbsp;') + "<br>";
					}
					text += "</font></pre>";
					infowindow.setContent(text);
					infowindow.open(map,marker);
				});
				
				mc.addMarker(marker);
				return marker;
			}
			
			function initialize(){
				console.log("Creating the map...");
				var options = {
					zoom: 12, 
					center: new google.maps.LatLng(40.782361, -73.965784), 
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById('map'), options); 

				//marker cluster
				mc = new MarkerClusterer(map, [], mcOptions);
				
				var key;
				var count = 0;
				console.log("Adding markers...");
				for (key in markerData) {
					if (markerData.hasOwnProperty(key)) {
						gmarkers.push(createMarker(key));
						count++;
					}
				}
				console.log("Done: Added " + count + " markers.");
			}
		</script>
		
		<div id="map"></div>
		
	</body>
</html>