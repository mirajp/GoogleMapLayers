<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Some Title</title>
		<script type="text/javascript"  src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/src/markerclusterer.js"></script>
		<script type="text/javascript" src="./lib/alasql.min.js"></script>
		<script type="text/javascript"> 
			console.log("Head script");
		</script> 
		<style>
			html, body, #map {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	
	<body onload='initMarkers()'>
		<script>
			var map, mc;
			var mcOptions = {gridSize: 20, maxZoom: 17};
			var headers;
			var markerData = {};
			var infowindow = new google.maps.InfoWindow();
			
			console.log("Body script");
			//var csvUrl = 'https://cdn.rawgit.com/albertyw/avenews/master/old/data/average-latitude-longitude-countries.csv';
			
			function initMarkers() {
				var csvUrl = 'http://localhost:8000/data/pscdata.csv';
				alasql('SELECT * FROM CSV("'+csvUrl+'",{headers:true})', [], function(data){
					//console.log(data);
					console.log(data.length);
					// Headers of the csv:
					headers = ['ID','Address','Latitude','Longitude','Date Time From','Date Time To','Fault Location',
									'Partial','Root Cause','Sub Cause','Ticket No','Weather','Customer Hrs','Duration','No Cust Interrupts'];
					for (var i = 0; i < data.length; i++) {
						if (data[i]['Latitude'] != "NOT FOUND") {
							var dataAddress = data[i]['Address'];
							// If the address is already in the markerData map, then append on values
							if (dataAddress in markerData) {
								var numEntries = markerData[dataAddress]['Num Entries'];
								numEntries++;
								markerData[dataAddress]['Num Entries'] = numEntries;
								
								for (var j = 0; j < headers.length; j++) {
									var headerName = headers[j];
									if (headerName != 'Address' && headerName != 'Latitude' && headerName != 'Longitude')
									markerData[dataAddress][headerName] += data[i][headerName];
									var newStrLength = (markerData[dataAddress][headerName]).length;
									var padAmount = (numEntries*32) - newStrLength;
									for (var p = 0; p < padAmount; p++) {
										markerData[dataAddress][headerName] += " ";
									}	
								}
							}
							else {
								markerData[dataAddress] = {};
								for (var j = 0; j < headers.length; j++) {
									var headerName = headers[j];
									markerData[dataAddress][headerName] = data[i][headerName];
								}
								markerData[dataAddress]['Num Entries'] = 1;
							}
						}
					}
					
					//console.log("Address of first object: " + data[0]["Address"]);
					//console.log("Weather of first object: " + data[0]["Weather"]);
					//console.log("Latitude of first object: " + data[0]["Latitude"]);
					//console.log("Longitude of first object: " + data[0]["Longitude"]);
					
					//var mySize = Object.size(markerData);
					//console.log("Length of marker data = " + mySize);
					//console.log(markerData['313 E 73 ST']['Num Entries']); // 8
					initialize();
				});
			}
			
			function createMarker(index) {
				var latlng = new google.maps.LatLng(parseFloat(markerData[index]['Latitude']),parseFloat(markerData[index]['Longitude']));
				var marker = new google.maps.Marker({
					position: latlng,
					map: map,
					title: markerData[index]['Address']
				});
				
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.close();
					
					var text = "<![CDATA[<b>$["	+ markerData[index]['Address'] + " - (" +  markerData[index]['Num Entries'] + ")</b>";
					for (var headerIter = 4; headerIter < headers.length; headerIter++) {
						var headerName = headers[headerIter];
						text +=  "</br>" + headerName + ": " + markerData[index][headerName];
					}
					text += "]]>";
					infowindow.setContent(text);
					infowindow.open(map,marker);
				});
				
				mc.addMarker(marker);
				return marker;
			}
			
			function initialize(){
				console.log("Inside initialize");
				var options = {
					zoom: 12, 
					center: new google.maps.LatLng(40.782361, -73.965784), 
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById('map'), options); 

				//marker cluster
				var gmarkers = [];
				mc = new MarkerClusterer(map, [], mcOptions);
				
				var key;
				var count = 0;
				for (key in markerData) {
					if (markerData.hasOwnProperty(key)) {
						gmarkers.push(createMarker(key));
						count++;
					}
				}
				console.log("Added " + count + " markers");
			}
		</script>
		
		<div id="map"></div>
		
	</body>
</html>